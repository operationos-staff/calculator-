<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç—É—Ä–æ–≤ ‚Äî –ü—Ö–∞–Ω–≥ –ù–≥–∞</title>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary: #0F4C75;
      --primary-light: #1B6CA8;
      --accent: #F4A621;
      --accent-light: #FFB84D;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      --bg: #F0F5FA;
      --card: #FFF;
      --text: #1E293B;
      --text-light: #64748B;
      --border: #E2E8F0;
      --shadow: 0 4px 24px rgba(15, 76, 117, .1);
      --radius: 16px;
      --radius-sm: 10px
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh
    }

    /* ‚îÄ‚îÄ OVERLAY LOGIN ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø–æ—Ä—Ç–∞–ª –¥–æ –≤—Ö–æ–¥–∞ ‚îÄ‚îÄ */
    #loginOverlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0F4C75 0%, #1B6CA8 100%);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px
    }

    #loginOverlay.hidden {
      display: none
    }

    .login-card {
      background: #fff;
      border-radius: 20px;
      padding: 40px 36px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
      text-align: center
    }

    .login-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #0F4C75, #1B6CA8);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin: 0 auto 16px
    }

    .login-title {
      font-size: 22px;
      font-weight: 800;
      color: #0F4C75;
      margin-bottom: 4px
    }

    .login-sub {
      font-size: 12px;
      color: #64748B;
      margin-bottom: 28px
    }

    .login-field {
      text-align: left;
      margin-bottom: 14px
    }

    .login-field label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      color: #64748B;
      text-transform: uppercase;
      letter-spacing: .4px;
      margin-bottom: 5px
    }

    .login-field input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #E2E8F0;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      outline: none;
      transition: border-color .2s;
      background: #F8FAFC
    }

    .login-field input:focus {
      border-color: #1B6CA8;
      background: #fff
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #0F4C75, #1B6CA8);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      margin-top: 6px;
      transition: all .2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px
    }

    .login-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(15, 76, 117, .4)
    }

    .login-btn:disabled {
      opacity: .6;
      cursor: not-allowed;
      transform: none
    }

    .login-err {
      background: #FEE2E2;
      border: 1px solid #FECACA;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 12px;
      color: #DC2626;
      margin-bottom: 14px;
      text-align: left;
      display: none
    }

    .login-err.show {
      display: block
    }

    .login-footer {
      font-size: 11px;
      color: #94A3B8;
      margin-top: 20px
    }

    /* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
    .spin {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, .4);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
      display: none
    }

    .spin.on {
      display: block
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    /* ‚îÄ‚îÄ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚îÄ‚îÄ */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px rgba(15, 76, 117, .3)
    }

    .header-inner {
      max-width: 1320px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      gap: 12px
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: #fff;
      cursor: pointer
    }

    .logo-icon {
      width: 42px;
      height: 42px;
      background: rgba(255, 255, 255, .2);
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px
    }

    .logo-title {
      font-size: 17px;
      font-weight: 700
    }

    .logo-sub {
      font-size: 11px;
      opacity: .7
    }

    .header-nav {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap
    }

    .btn-nav {
      padding: 7px 14px;
      border-radius: 7px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all .2s;
      display: flex;
      align-items: center;
      gap: 5px
    }

    .btn-nav-o {
      background: rgba(255, 255, 255, .15);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .3)
    }

    .btn-nav-o:hover {
      background: rgba(255, 255, 255, .25)
    }

    .btn-nav-a {
      background: var(--accent);
      color: var(--primary);
      font-weight: 700
    }

    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600
    }

    .role-m {
      background: #DBEAFE;
      color: #1D4ED8
    }

    .role-b {
      background: #FEF3C7;
      color: #92400E
    }

    .role-a {
      background: #FCE7F3;
      color: #9D174D
    }

    .main {
      max-width: 1320px;
      margin: 0 auto;
      padding: 20px 24px;
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px
    }

    @media(max-width:960px) {
      .main {
        grid-template-columns: 1fr
      }
    }

    .page {
      display: none
    }

    .page.active {
      display: block
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 16px
    }

    .card-h {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px
    }

    .card-h-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #fff;
      flex-shrink: 0
    }

    .card-h h2 {
      font-size: 14px;
      font-weight: 700
    }

    .card-h p {
      font-size: 11px;
      color: var(--text-light);
      margin-top: 1px
    }

    .card-b {
      padding: 18px 20px
    }

    .pkg-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 14px
    }

    @media(max-width:500px) {
      .pkg-grid {
        grid-template-columns: 1fr
      }
    }

    .pkg-card {
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px;
      cursor: pointer;
      transition: all .2s;
      position: relative;
      background: #fff;
      text-align: center
    }

    .pkg-card:hover {
      border-color: var(--primary-light);
      box-shadow: 0 2px 12px rgba(15, 76, 117, .08)
    }

    .pkg-card.sel {
      border-color: var(--primary);
      background: linear-gradient(135deg, #EBF5FF, #DBEAFE)
    }

    .pkg-card.sel::after {
      content: '‚úì';
      position: absolute;
      top: 8px;
      right: 10px;
      background: var(--primary);
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700
    }

    .pkg-icon {
      font-size: 26px;
      margin-bottom: 4px
    }

    .pkg-name {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 3px
    }

    .pkg-note {
      font-size: 10px;
      color: var(--text-light);
      margin-bottom: 6px;
      line-height: 1.4
    }

    .pkg-price {
      font-size: 20px;
      font-weight: 800;
      color: var(--primary)
    }

    .pkg-price span {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-light)
    }

    .pkg-netto {
      font-size: 10px;
      color: #92400E;
      margin-top: 4px;
      font-weight: 600
    }

    .vip-box {
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 14px;
      cursor: pointer;
      transition: all .2s;
      display: flex;
      align-items: center;
      gap: 12px;
      background: #FFFBEB
    }

    .vip-box:hover {
      border-color: var(--warning)
    }

    .vip-box.sel {
      border-color: var(--warning);
      border-style: solid;
      background: linear-gradient(135deg, #FEF3C7, #FDE68A)
    }

    .vip-chk {
      width: 22px;
      height: 22px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
      transition: all .2s
    }

    .vip-box.sel .vip-chk {
      background: var(--warning);
      border-color: var(--warning);
      color: #fff
    }

    .vip-info {
      flex: 1
    }

    .vip-name {
      font-size: 12px;
      font-weight: 700
    }

    .vip-note {
      font-size: 10px;
      color: var(--text-light);
      margin-top: 1px
    }

    .vip-price {
      font-size: 15px;
      font-weight: 800;
      color: #92400E;
      white-space: nowrap
    }

    .vip-netto {
      font-size: 10px;
      color: #92400E;
      margin-top: 2px
    }

    .cats {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px
    }

    .cat-btn {
      padding: 4px 11px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text-light);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s
    }

    .cat-btn:hover,
    .cat-btn.on {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary)
    }

    .otbl {
      width: 100%;
      border-collapse: collapse
    }

    .otbl thead th {
      background: var(--bg);
      padding: 7px 8px;
      font-size: 9px;
      font-weight: 700;
      color: var(--text-light);
      text-align: center;
      text-transform: uppercase;
      letter-spacing: .4px;
      border-bottom: 1px solid var(--border)
    }

    .otbl thead th:first-child {
      text-align: left
    }

    .otbl thead th.mk {
      background: #FEF3C7;
      color: #92400E
    }

    .otbl thead th.fn {
      background: #ECFDF5;
      color: #065F46
    }

    .orow {
      border-bottom: 1px solid #F1F5F9;
      transition: background .15s
    }

    .orow:hover {
      background: #F8FAFF
    }

    .orow.has {
      background: #F0FDF4
    }

    .orow td {
      padding: 7px 8px;
      vertical-align: middle;
      text-align: center;
      font-size: 11px
    }

    .orow td:first-child {
      text-align: left
    }

    .oname {
      font-size: 11px;
      font-weight: 500
    }

    .ocat {
      display: inline-block;
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 3px;
      font-weight: 500;
      margin-top: 1px
    }

    .qi {
      width: 48px;
      padding: 4px;
      border: 1.5px solid var(--border);
      border-radius: 5px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      outline: none;
      background: #fff;
      -moz-appearance: textfield
    }

    .qi:focus {
      border-color: var(--primary)
    }

    .qi::-webkit-inner-spin-button,
    .qi::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0
    }

    .mi {
      width: 52px;
      padding: 4px;
      border: 1.5px solid #FDE68A;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      outline: none;
      background: #FFFBEB;
      color: #92400E;
      -moz-appearance: textfield
    }

    .mi:focus {
      border-color: var(--warning)
    }

    .mi::-webkit-inner-spin-button,
    .mi::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0
    }

    .pc {
      font-weight: 600;
      color: var(--primary)
    }

    .pc.fr {
      color: var(--success)
    }

    .pc.sp {
      color: var(--text-light);
      font-size: 10px;
      font-style: italic
    }

    .sc {
      font-weight: 700;
      color: var(--primary)
    }

    .sc.z {
      color: var(--text-light);
      font-weight: 400
    }

    .mc {
      font-weight: 600;
      color: #92400E
    }

    .fc {
      font-weight: 800;
      color: var(--success)
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .field {
      margin-bottom: 10px
    }

    .field label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: .3px
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 8px 11px;
      border: 1.5px solid var(--border);
      border-radius: 7px;
      font-size: 12px;
      font-family: inherit;
      outline: none;
      background: #fff;
      transition: border-color .2s
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: var(--primary)
    }

    .field textarea {
      resize: vertical;
      min-height: 50px
    }

    .sline {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px dashed var(--border);
      font-size: 12px
    }

    .sline:last-child {
      border-bottom: none
    }

    .sline .sl {
      color: var(--text-light);
      font-size: 11px
    }

    .sline .sv {
      font-weight: 600
    }

    .stotal {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      border-radius: var(--radius-sm);
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0
    }

    .stotal .tl {
      font-size: 12px;
      font-weight: 600;
      opacity: .9
    }

    .stotal .ta {
      font-size: 22px;
      font-weight: 800
    }

    .stotal .tc {
      font-size: 10px;
      opacity: .7
    }

    .sopt {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: #F8FAFF;
      border: 1px solid #DBEAFE;
      border-radius: 7px;
      padding: 7px 10px;
      font-size: 11px;
      margin-bottom: 5px
    }

    .sopt-n {
      font-weight: 500
    }

    .sopt-d {
      font-size: 9px;
      color: var(--text-light);
      margin-top: 1px
    }

    .sopt-p {
      font-weight: 700;
      color: var(--primary);
      white-space: nowrap;
      margin-left: 6px
    }

    .btn {
      width: 100%;
      padding: 11px 18px;
      border-radius: 9px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all .2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      font-family: inherit
    }

    .btn-p {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff
    }

    .btn-p:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(15, 76, 117, .3)
    }

    .btn-ac {
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      color: #fff
    }

    .btn-s {
      background: linear-gradient(135deg, var(--success), #059669);
      color: #fff
    }

    .btn-g {
      background: var(--bg);
      color: var(--text-light);
      border: 1px solid var(--border)
    }

    .btn-g:hover {
      background: var(--border)
    }

    .btn-d {
      background: linear-gradient(135deg, var(--danger), #DC2626);
      color: #fff
    }

    .btn-w {
      background: linear-gradient(135deg, var(--warning), #D97706);
      color: #fff
    }

    .abtns {
      display: flex;
      flex-direction: column;
      gap: 7px
    }

    .netto-info {
      background: #FFF7ED;
      border: 1px solid #FDBA74;
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 10px;
      font-size: 13px;
      color: #9A3412;
      line-height: 1.6
    }

    .netto-info b {
      font-weight: 700;
      font-size: 13px
    }

    .mksec {
      background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
      border: 1px solid #FDE68A;
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-top: 12px
    }

    .mksec .mkt {
      font-size: 11px;
      font-weight: 700;
      color: #92400E;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px
    }

    .mkrow {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px
    }

    .mkf {
      position: relative
    }

    .mkf input {
      width: 100%;
      padding: 7px 28px 7px 9px;
      border: 1.5px solid #FDE68A;
      border-radius: 7px;
      font-size: 12px;
      font-weight: 600;
      outline: none;
      background: #fff
    }

    .mkf input:focus {
      border-color: var(--warning)
    }

    .mkf .su {
      position: absolute;
      right: 7px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      font-weight: 700;
      color: #92400E
    }

    .mkl {
      font-size: 9px;
      color: #92400E;
      margin-bottom: 2px;
      font-weight: 600;
      text-transform: uppercase
    }

    /* ‚îÄ‚îÄ –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê (–µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å .mo) ‚îÄ‚îÄ */
    .mo {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 76, 117, .5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center
    }

    .mo.open {
      display: flex
    }

    .md {
      background: #fff;
      border-radius: var(--radius);
      padding: 24px;
      max-width: 480px;
      width: 92%;
      box-shadow: 0 8px 40px rgba(15, 76, 117, .15);
      position: relative;
      max-height: 90vh;
      overflow-y: auto
    }

    .md-x {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--bg);
      border: none;
      cursor: pointer;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-light)
    }

    .md-t {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 5px
    }

    .md-s {
      font-size: 11px;
      color: var(--text-light);
      margin-bottom: 18px
    }

    .text-out {
      background: var(--bg);
      border-radius: 8px;
      padding: 12px;
      font-size: 11px;
      line-height: 1.7;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border);
      margin-bottom: 12px
    }

    .link-box {
      display: flex;
      gap: 6px;
      margin-top: 6px
    }

    .link-in {
      flex: 1;
      padding: 8px 10px;
      border: 1.5px solid var(--border);
      border-radius: 7px;
      font-size: 10px;
      background: var(--bg);
      outline: none
    }

    .btn-cp {
      padding: 8px 14px;
      border-radius: 7px;
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600
    }

    .empty {
      text-align: center;
      padding: 20px;
      color: var(--text-light)
    }

    .empty .ei {
      font-size: 32px;
      margin-bottom: 4px
    }

    .empty p {
      font-size: 11px
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--text);
      color: #fff;
      padding: 10px 18px;
      border-radius: 9px;
      font-size: 12px;
      font-weight: 500;
      box-shadow: 0 8px 40px rgba(15, 76, 117, .15);
      z-index: 9999;
      transform: translateY(100px);
      opacity: 0;
      transition: all .3s
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1
    }

    .toast.ok {
      background: var(--success)
    }

    .toast.err {
      background: var(--danger)
    }

    .bk-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      border-bottom: 2px solid var(--border);
      padding-bottom: 8px
    }

    .bk-tab {
      padding: 8px 16px;
      border-radius: 8px 8px 0 0;
      border: 1px solid var(--border);
      border-bottom: none;
      background: #fff;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
      color: var(--text-light)
    }

    .bk-tab.on {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary)
    }

    .bk-tab-content {
      display: none
    }

    .bk-tab-content.on {
      display: block
    }

    .pe td {
      padding: 5px 6px
    }

    .pe input {
      width: 100%;
      padding: 4px 6px;
      border: 1.5px solid var(--border);
      border-radius: 5px;
      font-size: 10px;
      text-align: right;
      font-weight: 600;
      outline: none
    }

    .pe input:focus {
      border-color: var(--accent)
    }

    .pe input[type="text"] {
      text-align: left
    }

    .pe th {
      background: var(--bg);
      font-size: 8px;
      font-weight: 700;
      color: var(--text-light);
      text-transform: uppercase;
      padding: 6px
    }

    .btn-add {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 8px 16px;
      border-radius: 8px;
      background: var(--success);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      margin-top: 10px;
      transition: all .2s
    }

    .btn-add:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(16, 185, 129, .3)
    }

    .btn-del {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: #FEE2E2;
      color: var(--danger);
      border: 1px solid #FECACA;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .15s
    }

    .btn-del:hover {
      background: var(--danger);
      color: #fff
    }

    .cp {
      max-width: 620px;
      margin: 0 auto;
      padding: 28px 20px
    }

    .cp-hero {
      text-align: center;
      margin-bottom: 24px
    }

    .cp-hero h1 {
      font-size: 22px;
      font-weight: 800;
      color: var(--primary);
      margin-top: 6px
    }

    .cp-hero p {
      color: var(--text-light);
      font-size: 12px;
      margin-top: 3px
    }

    .ct-box {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      border-radius: var(--radius);
      padding: 22px;
      text-align: center;
      margin: 16px 0
    }

    .ct-box .ctl {
      font-size: 11px;
      opacity: .85;
      margin-bottom: 5px
    }

    .ct-box .cta {
      font-size: 38px;
      font-weight: 800
    }

    .ct-box .ctc {
      font-size: 11px;
      opacity: .7;
      margin-top: 3px
    }

    @media print {
      body {
        background: #fff !important
      }

      .header,
      .toast,
      .no-print {
        display: none !important
      }

      .page {
        display: none !important
      }

      #printArea {
        display: block !important
      }
    }

    #printArea {
      display: none
    }

    #printArea .pp {
      font-family: 'Inter', Arial, sans-serif;
      padding: 20px;
      max-width: 680px;
      margin: 0 auto;
      color: #1E293B
    }

    #printArea .ph {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 14px;
      border-bottom: 2px solid #0F4C75;
      margin-bottom: 16px
    }

    #printArea .pc-name {
      font-size: 18px;
      font-weight: 800;
      color: #0F4C75
    }

    #printArea .pc-sub {
      font-size: 11px;
      color: #64748B;
      margin-top: 2px
    }

    #printArea table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 14px
    }

    #printArea table th {
      background: #0F4C75;
      color: #fff;
      padding: 7px 9px;
      font-size: 9px;
      text-align: left;
      text-transform: uppercase
    }

    #printArea table td {
      padding: 6px 9px;
      border-bottom: 1px solid #E2E8F0;
      font-size: 10px
    }

    #printArea table tr:nth-child(even) td {
      background: #F8FAFF
    }

    #printArea .pt {
      background: #0F4C75;
      color: #fff;
      border-radius: 8px;
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    #printArea .pi {
      background: #F0F5FA;
      border-radius: 7px;
      padding: 10px;
      margin-bottom: 14px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 7px
    }

    #printArea .pi-l {
      font-size: 8px;
      font-weight: 700;
      color: #64748B;
      text-transform: uppercase
    }

    #printArea .pi-v {
      font-size: 12px;
      font-weight: 700;
      margin-top: 1px
    }

    ::-webkit-scrollbar {
      width: 5px
    }

    ::-webkit-scrollbar-track {
      background: #F1F5F9
    }

    ::-webkit-scrollbar-thumb {
      background: #CBD5E1;
      border-radius: 3px
    }

    @media(max-width:640px) {
      .header-inner {
        padding: 10px 14px
      }

      .logo-sub {
        display: none
      }

      .main {
        padding: 12px;
        gap: 12px
      }

      .card-b {
        padding: 12px 14px
      }

      .pkg-grid {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       OVERLAY ‚Äî –≠–ö–†–ê–ù –í–•–û–î–ê (–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø–æ—Ä—Ç–∞–ª)
       –°–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="loginOverlay">
    <div class="login-card">
      <div class="login-logo">üå¥</div>
      <div class="login-title">–ü—Ö–∞–Ω–≥ –ù–≥–∞ –¢—É—Ä—ã</div>
      <div class="login-sub">–ü–æ—Ä—Ç–∞–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–∞–º–∏ ¬∑ –í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>

      <div class="login-err" id="loginErr">‚ùå <span id="loginErrMsg"></span></div>

      <div class="login-field">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="manager@tour.local" autocomplete="username"
          onkeydown="if(event.key==='Enter')document.getElementById('loginPass').focus()">
      </div>
      <div class="login-field">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
          onkeydown="if(event.key==='Enter')doSupabaseLogin()">
      </div>

      <button class="login-btn" id="loginBtn" onclick="doSupabaseLogin()">
        <div class="spin" id="loginSpin"></div>
        <span id="loginBtnText">üîê –í–æ–π—Ç–∏ –≤ –ø–æ—Ä—Ç–∞–ª</span>
      </button>

      <div class="login-footer">–ü—Ö–∞–Ω–≥ –ù–≥–∞ –¢—É—Ä—ã ¬∑ –¢–∞–π–ª–∞–Ω–¥ ¬∑ –¢–æ–ª—å–∫–æ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° (—Å–∫—Ä—ã—Ç –¥–æ –≤—Ö–æ–¥–∞)
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="appRoot" style="display:none">

    <header class="header no-print">
      <div class="header-inner">
        <div class="logo" onclick="showPage('calculator')">
          <div class="logo-icon">üå¥</div>
          <div>
            <div class="logo-title">–ü—Ö–∞–Ω–≥ –ù–≥–∞ –¢—É—Ä—ã</div>
            <div class="logo-sub">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç—É—Ä–æ–≤</div>
          </div>
        </div>
        <nav class="header-nav" id="headerNav">
          <span id="roleDisp" class="role-badge role-m" style="display:none"></span>
          <button class="btn-nav btn-nav-o" onclick="showPage('calculator')">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
          <button class="btn-nav btn-nav-a" id="btnAuth" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
        </nav>
      </div>
    </header>

    <!-- Text modal -->
    <div class="mo" id="textModal">
      <div class="md">
        <button class="md-x" onclick="closeModal('textModal')">‚úï</button>
        <div class="md-t">üì± –¢–µ–∫—Å—Ç –¥–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞</div>
        <div class="text-out" id="textOut"></div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-p" style="flex:1" onclick="copyText()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn btn-g" style="flex:1" onclick="closeModal('textModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Link modal -->
    <div class="mo" id="linkModal">
      <div class="md">
        <button class="md-x" onclick="closeModal('linkModal')">‚úï</button>
        <div class="md-t">üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞</div>
        <div class="md-s">–ö—Ä–∞—Å–∏–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞—Å—á—ë—Ç–∞ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
        <div class="link-box">
          <input type="text" class="link-in" id="shareUrl" readonly>
          <button class="btn-cp" onclick="copyLink()">üìã</button>
        </div>
        <div
          style="background:#F0FDF4;border-radius:7px;padding:10px;font-size:10px;color:#065F46;margin-top:10px;border:1px solid #A7F3D0">
          ‚úÖ –ö–ª–∏–µ–Ω—Ç —É–≤–∏–¥–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã. –ù–∞—Ü–µ–Ω–∫–∏ —Å–∫—Ä—ã—Ç—ã.
        </div>
      </div>
    </div>

    <!-- Add Option modal -->
    <div class="mo" id="addOptModal">
      <div class="md" style="max-width:440px">
        <button class="md-x" onclick="closeModal('addOptModal')">‚úï</button>
        <div class="md-t">‚ûï –ù–æ–≤–∞—è –æ–ø—Ü–∏—è</div>
        <div class="md-s">–î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–∫—É—Ä—Å–∏—é / –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
        <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="newOptName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ü–∏–∏...">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div class="field"><label>–¶–µ–Ω–∞ –º–µ–Ω–µ–¥–∂. –≤–∑—Ä.</label><input type="number" id="newOptMgrA" value="0" min="0">
          </div>
          <div class="field"><label>–¶–µ–Ω–∞ –º–µ–Ω–µ–¥–∂. –¥–µ—Ç.</label><input type="number" id="newOptMgrC" value="0" min="0">
          </div>
          <div class="field"><label>–ù–µ—Ç—Ç–æ –≤–∑—Ä.</label><input type="number" id="newOptNetA" value="0" min="0"></div>
          <div class="field"><label>–ù–µ—Ç—Ç–æ –¥–µ—Ç.</label><input type="number" id="newOptNetC" value="0" min="0"></div>
        </div>
        <div class="field"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="newOptCat">
            <option>–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</option>
            <option>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</option>
            <option>–•—Ä–∞–º—ã</option>
            <option>–ö—É–ª—å—Ç—É—Ä–Ω—ã–µ</option>
            <option>–ñ–∏–≤–æ—Ç–Ω—ã–µ</option>
            <option>–°–ø–∞</option>
            <option>–ü–∏—Ç–∞–Ω–∏–µ</option>
            <option>–ü—Ä–∏—Ä–æ–¥–∞</option>
            <option>–ü–ª—è–∂–∏</option>
          </select>
        </div>
        <div class="field"><label style="display:flex;align-items:center;gap:6px;text-transform:none">
            <input type="checkbox" id="newOptOnly8" style="width:auto"> –¢–æ–ª—å–∫–æ –¥–ª—è 8-—á–∞—Å–æ–≤–æ–≥–æ –ø–∞–∫–µ—Ç–∞
          </label></div>
        <button class="btn btn-s" onclick="addNewOpt()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- ========== PAGE: CALCULATOR ========== -->
    <div class="page active" id="page-calculator">
      <div class="main">
        <div>

          <!-- PACKAGES -->
          <div class="card">
            <div class="card-h">
              <div class="card-h-icon">üöê</div>
              <div>
                <h2>–ë–∞–∑–æ–≤—ã–π –ø–∞–∫–µ—Ç</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—É—Ä–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</p>
              </div>
            </div>
            <div class="card-b">
              <div
                style="font-size:11px;font-weight:700;color:var(--text-light);margin-bottom:6px;text-transform:uppercase">
                ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
              <div class="pkg-grid" id="baseGrid"></div>

              <div
                style="font-size:11px;font-weight:700;color:#92400E;margin-bottom:6px;margin-top:14px;text-transform:uppercase">
                ‚≠ê VIP –ú–∏–Ω–∏–≤—ç–Ω –ê–ª—å—Ñ–∞—Ä–¥ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</div>
              <div id="vipBox"></div>

              <div id="nettoInfo" class="netto-info" style="display:none"></div>
              <div id="pkgMkSec" style="display:none">
                <div class="mksec">
                  <div class="mkt">üí∞ –ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –ø–∞–∫–µ—Ç</div>
                  <div class="mkrow">
                    <div>
                      <div class="mkl">–§–∏–∫—Å. ‡∏ø</div>
                      <div class="mkf"><input type="number" id="pkgMkB" value="0" min="0" oninput="recalc()"><span
                          class="su">‡∏ø</span></div>
                    </div>
                    <div>
                      <div class="mkl">–ü—Ä–æ—Ü–µ–Ω—Ç %</div>
                      <div class="mkf"><input type="number" id="pkgMkP" value="0" min="0" max="200"
                          oninput="recalc()"><span class="su">%</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- OPTIONS -->
          <div class="card">
            <div class="card-h">
              <div class="card-h-icon">üéØ</div>
              <div>
                <h2>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏</h2>
                <p id="optSubtitle">–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ –¥–µ—Ç–µ–π</p>
              </div>
            </div>
            <div class="card-b" style="padding:10px 14px">
              <div class="cats" id="catFilters"></div>
              <div style="overflow-x:auto">
                <table class="otbl">
                  <thead>
                    <tr id="optHead"></tr>
                  </thead>
                  <tbody id="optBody"></tbody>
                </table>
              </div>
              <div id="optNotice"
                style="display:none;margin-top:10px;padding:10px;background:#FEF3C7;border-radius:8px;font-size:11px;color:#92400E;border:1px solid #FDE68A">
                ‚è±Ô∏è <b>–ü–∞–∫–µ—Ç 5 —á–∞—Å–æ–≤:</b> –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–ø—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ 8 —á–∞—Å–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.
              </div>
              <div id="addOptBtn" style="display:none;margin-top:12px">
                <button class="btn-add" onclick="openAddOpt()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –æ–ø—Ü–∏—é</button>
              </div>
            </div>
          </div>

        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">

          <div class="card">
            <div class="card-h">
              <div class="card-h-icon">üë§</div>
              <div>
                <h2>–ö–ª–∏–µ–Ω—Ç</h2>
              </div>
            </div>
            <div class="card-b">
              <div class="field"><label>–ò–º—è</label><input type="text" id="cName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"></div>
              <div class="field"><label>–î–∞—Ç–∞ —Ç—É—Ä–∞</label><input type="date" id="cDate"></div>
              <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω / WhatsApp</label><input type="text" id="cPhone"
                  placeholder="+66 XX XXX XXXX"></div>
              <div class="field"><label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label><textarea id="cNote" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h">
              <div class="card-h-icon" style="background:linear-gradient(135deg,#10B981,#059669)">üí≥</div>
              <div>
                <h2>–ò—Ç–æ–≥–æ</h2>
                <p>–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
              </div>
            </div>
            <div class="card-b">
              <div id="sumLines"></div>
              <div class="stotal">
                <div>
                  <div class="tl">–ö –û–ü–õ–ê–¢–ï</div>
                  <div class="tc">THB (–±–∞—Ç)</div>
                </div>
                <div class="ta" id="sumTotal">0 ‡∏ø</div>
              </div>
              <div style="margin-bottom:12px">
                <div style="font-size:11px;font-weight:700;color:var(--text-light);margin-bottom:6px">–í–´–ë–†–ê–ù–ù–´–ï –ü–û–ó–ò–¶–ò–ò
                </div>
                <div id="selList">
                  <div class="empty">
                    <div class="ei">üéØ</div>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç</p>
                  </div>
                </div>
              </div>
              <div class="abtns">
                <button class="btn btn-p" onclick="doPrint()">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
                <button class="btn btn-ac" onclick="showText()">üì± –¢–µ–∫—Å—Ç</button>
                <button class="btn btn-s" onclick="genLink()">üîó –°—Å—ã–ª–∫–∞ –∫–ª–∏–µ–Ω—Ç—É</button>
                <button class="btn btn-g" onclick="resetAll()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- ========== PAGE: BOOKING (includes admin) ========== -->
    <div class="page" id="page-booking">
      <div style="max-width:1100px;margin:0 auto;padding:20px">
        <div
          style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
          <div>
            <h1 style="font-size:18px;font-weight:800">üìã –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –æ—Ç–¥–µ–ª</h1>
            <p style="font-size:11px;color:var(--text-light)">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–∞–º–∏, –ø–∞–∫–µ—Ç–∞–º–∏ –∏ –æ–ø—Ü–∏—è–º–∏</p>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-p" onclick="saveAdmin()"
              style="width:auto;padding:9px 18px">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
            <button class="btn btn-g" onclick="showPage('calculator')" style="width:auto;padding:9px 18px">‚Üê
              –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
          </div>
        </div>

        <div class="bk-tabs">
          <button class="bk-tab on" onclick="bkTab('calc')">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
          <button class="bk-tab" onclick="bkTab('pkgs')">üöê –ü–∞–∫–µ—Ç—ã</button>
          <button class="bk-tab" onclick="bkTab('opts')">üéØ –û–ø—Ü–∏–∏</button>
          <button class="bk-tab" onclick="bkTab('addrem')">‚ûï –î–æ–±–∞–≤–∏—Ç—å / –£–¥–∞–ª–∏—Ç—å</button>
        </div>

        <div class="bk-tab-content on" id="bkt-calc">
          <div class="card">
            <div class="card-b" style="text-align:center;padding:40px">
              <div style="font-size:48px;margin-bottom:12px">üßÆ</div>
              <h2 style="margin-bottom:8px">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É</h2>
              <p style="color:var(--text-light);margin-bottom:16px;font-size:13px">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å –Ω–µ—Ç—Ç–æ-—Ü–µ–Ω–∞–º–∏ –∏
                –Ω–∞—Ü–µ–Ω–∫–∞–º–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ</p>
              <button class="btn btn-p" onclick="showPage('calculator')"
                style="width:auto;padding:12px 28px;margin:0 auto">üßÆ –û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
            </div>
          </div>
        </div>

        <div class="bk-tab-content" id="bkt-pkgs">
          <div class="card">
            <div class="card-h">
              <div class="card-h-icon">üöê</div>
              <div>
                <h2>–ë–∞–∑–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã –∏ VIP</h2>
                <p>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω</p>
              </div>
            </div>
            <div class="card-b" style="overflow-x:auto">
              <table class="pe" style="width:100%;border-collapse:collapse">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>–¢–∏–ø</th>
                    <th>–ß–∞—Å—ã</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–¶–µ–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä ‡∏ø</th>
                    <th>–ù–µ—Ç—Ç–æ ‡∏ø</th>
                    <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                    <th>–ù–µ—Ç—Ç–æ –¥–µ—Ç–∞–ª–∏</th>
                  </tr>
                </thead>
                <tbody id="aPkgTbl"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="bk-tab-content" id="bkt-opts">
          <div class="card">
            <div class="card-h">
              <div class="card-h-icon">üéØ</div>
              <div>
                <h2>–¶–µ–Ω—ã –æ–ø—Ü–∏–π</h2>
                <p>–ú–µ–Ω–µ–¥–∂–µ—Ä—Å–∫–∏–µ –∏ –Ω–µ—Ç—Ç–æ-—Ü–µ–Ω—ã</p>
              </div>
            </div>
            <div class="card-b" style="overflow-x:auto">
              <table class="pe" style="width:100%;border-collapse:collapse">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ú–µ–Ω–µ–¥–∂. –≤–∑—Ä.</th>
                    <th>–ú–µ–Ω–µ–¥–∂. –¥–µ—Ç.</th>
                    <th>–ù–µ—Ç—Ç–æ –≤–∑—Ä.</th>
                    <th>–ù–µ—Ç—Ç–æ –¥–µ—Ç.</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–¢–æ–ª—å–∫–æ 8—á</th>
                  </tr>
                </thead>
                <tbody id="aOptTbl"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="bk-tab-content" id="bkt-addrem">
          <div class="card">
            <div class="card-h">
              <div class="card-h-icon" style="background:linear-gradient(135deg,var(--success),#059669)">‚ûï</div>
              <div>
                <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –æ–ø—Ü–∏—é</h2>
                <p>–ù–æ–≤–∞—è —ç–∫—Å–∫—É—Ä—Å–∏—è / –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
              </div>
            </div>
            <div class="card-b">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:600px">
                <div class="field" style="grid-column:1/-1"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="admNewName"
                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ü–∏–∏..."></div>
                <div class="field"><label>–¶–µ–Ω–∞ –º–µ–Ω–µ–¥–∂. –≤–∑—Ä.</label><input type="number" id="admNewMgrA" value="0"
                    min="0"></div>
                <div class="field"><label>–¶–µ–Ω–∞ –º–µ–Ω–µ–¥–∂. –¥–µ—Ç.</label><input type="number" id="admNewMgrC" value="0"
                    min="0"></div>
                <div class="field"><label>–ù–µ—Ç—Ç–æ –≤–∑—Ä.</label><input type="number" id="admNewNetA" value="0" min="0">
                </div>
                <div class="field"><label>–ù–µ—Ç—Ç–æ –¥–µ—Ç.</label><input type="number" id="admNewNetC" value="0" min="0">
                </div>
                <div class="field"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                  <select id="admNewCat">
                    <option>–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</option>
                    <option>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</option>
                    <option>–•—Ä–∞–º—ã</option>
                    <option>–ö—É–ª—å—Ç—É—Ä–Ω—ã–µ</option>
                    <option>–ñ–∏–≤–æ—Ç–Ω—ã–µ</option>
                    <option>–°–ø–∞</option>
                    <option>–ü–∏—Ç–∞–Ω–∏–µ</option>
                    <option>–ü—Ä–∏—Ä–æ–¥–∞</option>
                    <option>–ü–ª—è–∂–∏</option>
                  </select>
                </div>
                <div class="field"><label style="display:flex;align-items:center;gap:6px;text-transform:none">
                    <input type="checkbox" id="admNewOnly8" style="width:auto"> –¢–æ–ª—å–∫–æ 8—á
                  </label></div>
              </div>
              <button class="btn btn-s" onclick="addOptFromAdmin()"
                style="width:auto;padding:10px 24px;margin-top:8px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é</button>
            </div>
          </div>

          <div class="card">
            <div class="card-h">
              <div class="card-h-icon" style="background:linear-gradient(135deg,var(--danger),#DC2626)">üóëÔ∏è</div>
              <div>
                <h2>–£–¥–∞–ª–∏—Ç—å –æ–ø—Ü–∏–∏</h2>
                <p>–ù–∞–∂–º–∏—Ç–µ ‚úï —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å</p>
              </div>
            </div>
            <div class="card-b" id="deleteOptsList"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- ========== PAGE: CLIENT (public view) ========== -->
    <div class="page" id="page-client">
      <div class="cp" id="clientPage"></div>
    </div>

    <!-- PRINT -->
    <div id="printArea"></div>

  </div><!-- /appRoot -->

  <!-- TOAST -->
  <div class="toast" id="toast"><span id="toastMsg"></span></div>

  <!-- Supabase CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SUPABASE CONFIG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const SUPABASE_URL = 'https://ufsvwlirjkcjkcouwgss.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmc3Z3bGlyamtjamtjb3V3Z3NzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNDE0NTIsImV4cCI6MjA4NzcxNzQ1Mn0.AW7Bkn-Kxqpfe3e9AiQ-7cNdnkp8RPsu4UGHGgfpxWY';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUTH STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentUser = null;
    let currentRole = null;

    // ‚îÄ‚îÄ –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π –≤—Ö–æ–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showLoginOverlay() {
      document.getElementById('loginOverlay').classList.remove('hidden');
      document.getElementById('appRoot').style.display = 'none';
    }

    function hideLoginOverlay() {
      document.getElementById('loginOverlay').classList.add('hidden');
      document.getElementById('appRoot').style.display = 'block';
    }

    // ‚îÄ‚îÄ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setLoginLoading(on) {
      const btn = document.getElementById('loginBtn');
      const spin = document.getElementById('loginSpin');
      const txt = document.getElementById('loginBtnText');
      btn.disabled = on;
      spin.classList.toggle('on', on);
      txt.textContent = on ? '–í—Ö–æ–¥–∏–º...' : 'üîê –í–æ–π—Ç–∏ –≤ –ø–æ—Ä—Ç–∞–ª';
    }

    // ‚îÄ‚îÄ –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤—Ö–æ–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showLoginError(msg) {
      const el = document.getElementById('loginErr');
      document.getElementById('loginErrMsg').textContent = msg;
      el.classList.add('show');
    }

    function hideLoginError() {
      document.getElementById('loginErr').classList.remove('show');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SUPABASE LOGIN ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function doSupabaseLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;

      if (!email || !pass) {
        showLoginError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
        return;
      }

      hideLoginError();
      setLoginLoading(true);

      const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: pass
      });

      setLoginLoading(false);

      if (error) {
        showLoginError('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
        return;
      }

      currentUser = data.user;
      await fetchRole();
      onLoginSuccess();
    }

    // ‚îÄ‚îÄ –ü–æ–ª—É—á–∏—Ç—å —Ä–æ–ª—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã user_roles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function fetchRole() {
      if (!currentUser) { currentRole = null; return; }

      const { data, error } = await supabase
        .from('user_roles')
        .select('role')
        .eq('user_id', currentUser.id)
        .single();

      currentRole = error ? null : data.role;
    }

    // ‚îÄ‚îÄ –í—ã—Ö–æ–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function logout() {
      await supabase.auth.signOut();
      currentUser = null;
      currentRole = null;
      S.role = null;
      S.optMk = {};
      // –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è –ª–æ–≥–∏–Ω–∞
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPass').value = '';
      hideLoginError();
      showLoginOverlay();
      toast('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
    }

    // ‚îÄ‚îÄ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function onLoginSuccess() {
      S.role = currentRole;
      hideLoginOverlay();
      applyRole();
      renderAll();
      document.getElementById('cDate').value = new Date().toISOString().split('T')[0];
      // –ï—Å–ª–∏ —Ä–æ–ª—å booking ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª –≤ —Ö–µ–¥–µ—Ä–µ
      if (S.role === 'booking') {
        const nav = document.getElementById('headerNav');
        if (!document.getElementById('btnBooking')) {
          const btn = document.createElement('button');
          btn.id = 'btnBooking';
          btn.className = 'btn-nav btn-nav-o';
          btn.innerHTML = 'üìã –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π';
          btn.onclick = () => { renderAdmin(); showPage('booking'); };
          nav.insertBefore(btn, document.getElementById('btnAuth'));
        }
      }
      toast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + (currentUser.email || '') + '!', 'ok');
    }

    // ‚îÄ‚îÄ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function restoreSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        currentUser = session.user;
        await fetchRole();
        onLoginSuccess();
      } else {
        showLoginOverlay();
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CRUD ‚Äî –ø–∞–∫–µ—Ç—ã
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadPackages() {
      const { data, error } = await supabase
        .from('packages')
        .select('*')
        .order('sort_order');

      if (error) { console.error('loadPackages', error); return []; }
      return data.map(p => ({
        id: p.id,
        type: p.type,
        hours: p.hours,
        name: p.name_ru,
        mgrPrice: p.mgr_price,
        nettoPrice: p.netto_price,
        nettoDetail: p.netto_detail,
        extraHour: p.extra_hour,
        note: p.note
      }));
    }

    async function savePackage(pkg) {
      const row = {
        type: pkg.type,
        hours: pkg.hours,
        name_ru: pkg.name,
        mgr_price: pkg.mgrPrice,
        netto_price: pkg.nettoPrice,
        netto_detail: pkg.nettoDetail || '',
        extra_hour: pkg.extraHour || 1000,
        note: pkg.note || '',
        updated_at: new Date().toISOString()
      };

      if (pkg.id) {
        const { error } = await supabase
          .from('packages')
          .update(row)
          .eq('id', pkg.id);
        if (error) alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞–∫–µ—Ç–∞: ' + error.message);
      } else {
        const { data, error } = await supabase
          .from('packages')
          .insert(row)
          .select()
          .single();
        if (error) alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–∞: ' + error.message);
        else pkg.id = data.id;
      }
    }

    async function deletePackage(id) {
      const { error } = await supabase.from('packages').delete().eq('id', id);
      if (error) alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CRUD ‚Äî –æ–ø—Ü–∏–∏
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadOptions() {
      const { data, error } = await supabase
        .from('options')
        .select('*')
        .order('sort_order');

      if (error) { console.error('loadOptions', error); return []; }
      return data.map(o => ({
        id: o.id,
        name: o.name_ru,
        priceA: o.mgr_price_adult,
        priceC: o.mgr_price_child,
        netA: o.net_price_adult,
        netC: o.net_price_child,
        only8h: o.only_8h,
        category: o.category,
        note: o.note,
        qtyA: 0, qtyC: 0,
        markupA: 0, markupC: 0
      }));
    }

    async function saveOption(opt) {
      const row = {
        name_ru: opt.name,
        mgr_price_adult: opt.priceA,
        mgr_price_child: opt.priceC,
        net_price_adult: opt.netA,
        net_price_child: opt.netC,
        only_8h: opt.only8h || false,
        category: opt.category || 'attraction',
        note: opt.note || '',
        updated_at: new Date().toISOString()
      };

      if (opt.id) {
        const { error } = await supabase
          .from('options')
          .update(row)
          .eq('id', opt.id);
        if (error) alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø—Ü–∏–∏: ' + error.message);
      } else {
        const { data, error } = await supabase
          .from('options')
          .insert(row)
          .select()
          .single();
        if (error) alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–∏: ' + error.message);
        else opt.id = data.id;
      }
    }

    async function deleteOptionDB(id) {
      const { error } = await supabase.from('options').delete().eq('id', id);
      if (error) alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CRUD ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞ (—Å—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function saveCalculation(clientName, tourDate, payload) {
      const { data, error } = await supabase
        .from('calculations')
        .insert({
          created_by: currentUser.id,
          client_name: clientName,
          tour_date: tourDate,
          payload: payload
        })
        .select()
        .single();

      if (error) { alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message); return null; }
      return data.id;
    }

    async function loadCalculation(calcId) {
      const { data, error } = await supabase
        .from('calculations')
        .select('payload, client_name, tour_date')
        .eq('id', calcId)
        .single();

      if (error) { console.error(error); return null; }
      return data;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  onPackage / onOption cell blur (Supabase sync)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function onPackageCellBlur(pkgId, field, newValue) {
      const pkg = S.packages.find(p => p.id === pkgId);
      if (!pkg) return;
      pkg[field] = isNaN(newValue) ? newValue : parseInt(newValue);
      await savePackage(pkg);
      recalc();
    }

    async function onOptionCellBlur(optId, field, newValue) {
      const opt = S.options.find(o => o.id === optId);
      if (!opt) return;
      opt[field] = isNaN(newValue) ? newValue : parseInt(newValue);
      await saveOption(opt);
      recalc();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  –ï–î–ò–ù–ê–Ø –¢–û–ß–ö–ê –í–•–û–î–ê ‚Äî initApp
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function initApp() {
      // 1. –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ ?tour=UUID
      const params = new URLSearchParams(location.search);
      const tourId = params.get('tour');

      if (tourId && tourId.length === 36) {
        // UUID ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å—á—ë—Ç –∏–∑ –ë–î –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const calc = await loadCalculation(tourId);
        if (calc) {
          hideLoginOverlay();
          renderClientPage(calc.payload);
          return;
        }
      }

      // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å base64-—Å—Å—ã–ª–∫—É (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
      if (tourId) {
        try {
          const d = JSON.parse(decodeURIComponent(atob(tourId)));
          hideLoginOverlay();
          renderClientPage(d);
          return;
        } catch (e) { /* –Ω–µ base64 ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º */ }
      }

      // 3. –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      loadSt();

      // 4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é Supabase –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
      await restoreSession();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>

  <script>

    // ============================================================
    // DATA
    // ============================================================
    const PACKAGES = [
      { id: 'base8', type: 'base', hours: 8, name: '–ë–∞–∑–æ–≤—ã–π 8 —á–∞—Å–æ–≤', mgrPrice: 15000, nettoPrice: 9500, note: '–º–∏–Ω–∏–≤—ç–Ω, —Ä—É—Å—Å–∫–∏–π –≥–∏–¥, –ª–æ–Ω–≥—Ç–µ–π–ª', nettoDetail: '–≤—ç–Ω 3500 + –≥–∏–¥ 2000 + –ª–æ–¥–∫–∞ 4000', extraHour: 1000 },
      { id: 'base5', type: 'base', hours: 5, name: '–ë–∞–∑–æ–≤—ã–π 5 —á–∞—Å–æ–≤', mgrPrice: 10000, nettoPrice: 5500, note: '–º–∏–Ω–∏–≤—ç–Ω, —Ä—É—Å—Å–∫–∏–π –≥–∏–¥', nettoDetail: '–≤—ç–Ω 3500 + –≥–∏–¥ 2000', extraHour: 1000 },
      { id: 'vip8', type: 'vip', hours: 8, name: 'VIP –¢–æ–π–æ—Ç–∞ –ê–ª—å—Ñ–∞—Ä–¥ 8 —á–∞—Å–æ–≤', mgrPrice: 25000, nettoPrice: 9500, note: '–¢–æ–π–æ—Ç–∞ –ê–ª—å—Ñ–∞—Ä–¥ (4-5 —á–µ–ª), –≥–∏–¥, –ª–æ–Ω–≥—Ç–µ–π–ª', nettoDetail: '–ê–ª—å—Ñ–∞—Ä–¥ 9500' },
      { id: 'vip5', type: 'vip', hours: 5, name: 'VIP –¢–æ–π–æ—Ç–∞ –ê–ª—å—Ñ–∞—Ä–¥ 5 —á–∞—Å–æ–≤', mgrPrice: 20000, nettoPrice: 9500, note: '–¢–æ–π–æ—Ç–∞ –ê–ª—å—Ñ–∞—Ä–¥ (4-5 —á–µ–ª), –≥–∏–¥', nettoDetail: '–ê–ª—å—Ñ–∞—Ä–¥ 9500' },
    ];

    const DEF_OPTIONS = [
      { id: 1, name: '–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –º–æ—Å—Ç', mgrA: 800, mgrC: 550, netA: 500, netC: 300, cat: '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', only8h: false },
      { id: 2, name: '–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –º–æ—Å—Ç + –∑–∞–≤—Ç—Ä–∞–∫/–æ–±–µ–¥', mgrA: 1000, mgrC: 800, netA: 600, netC: 400, cat: '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', only8h: false },
      { id: 3, name: '–ù–∞—Ü. –ø–∞—Ä–∫ –î–∂–µ–π–º—Å–∞ –ë–æ–Ω–¥–∞', mgrA: 300, mgrC: 150, netA: 300, netC: 150, cat: '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', only8h: true },
      { id: 4, name: '–ö–∞—Ç–∞–Ω–∏–µ –Ω–∞ –∫–∞–Ω–æ—ç', mgrA: 250, mgrC: 250, netA: 150, netC: 150, cat: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', only8h: true },
      { id: 5, name: '–•—Ä–∞–º –°—É–≤–∞–Ω–∫—É—Ö–∞ (–æ–±–µ–∑—å—è–Ω—ã)', mgrA: 20, mgrC: 20, netA: 20, netC: 20, cat: '–•—Ä–∞–º—ã', only8h: false },
      { id: 6, name: '–°–º–æ—Ç—Ä–æ–≤–∞—è –°–∞–º–µ—Ç (–±–µ–∑ –º–æ—Å—Ç–∞)', mgrA: 300, mgrC: 200, netA: 100, netC: 100, cat: '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', only8h: false },
      { id: 7, name: '–î–µ—Ä–µ–≤–Ω—è –∫–∞—Ä–µ–Ω–æ–≤', mgrA: 500, mgrC: 400, netA: 250, netC: 200, cat: '–ö—É–ª—å—Ç—É—Ä–Ω—ã–µ', only8h: false },
      { id: 8, name: '–î–µ—Ä–µ–≤–Ω—è —Å–ª–æ–Ω–æ–≤', mgrA: 500, mgrC: 400, netA: 250, netC: 200, cat: '–ñ–∏–≤–æ—Ç–Ω—ã–µ', only8h: false },
      { id: 9, name: '–ú–∞–Ω—Ç—Ä–∞ –°–ø–∞', mgrA: 1200, mgrC: 1000, netA: 990, netC: 790, cat: '–°–ø–∞', only8h: true },
      { id: 10, name: '–û–±–µ–¥ –≤ —Ü—ã–≥–∞–Ω—Å–∫–æ–π –¥–µ—Ä–µ–≤–Ω–µ', mgrA: 350, mgrC: 250, netA: 250, netC: 125, cat: '–ü–∏—Ç–∞–Ω–∏–µ', only8h: true },
      { id: 11, name: '–•—Ä–∞–º –ê–¥–∞ –∏ –†–∞—è', mgrA: 0, mgrC: 0, netA: 0, netC: 0, cat: '–•—Ä–∞–º—ã', only8h: false, free: true },
      { id: 12, name: '–í–æ–¥–æ–ø–∞–¥', mgrA: 200, mgrC: 100, netA: 100, netC: 50, cat: '–ü—Ä–∏—Ä–æ–¥–∞', only8h: false },
      { id: 13, name: '–ë–µ–ª—ã–π —Ö—Ä–∞–º', mgrA: 0, mgrC: 0, netA: 0, netC: 0, cat: '–•—Ä–∞–º—ã', only8h: false, free: true },
      { id: 14, name: '–ö–∞—Ñ–µ —Å –∫—É–≤—à–∏–Ω–∫–∞–º–∏', mgrA: 0, mgrC: 0, netA: 0, netC: 0, cat: '–ü–∏—Ç–∞–Ω–∏–µ', only8h: false, special: '–∑–∞–∫–∞–∑–∞—Ç—å –Ω–∞–ø–∏—Ç–æ–∫' },
      { id: 15, name: '–ü–ª—è–∂ —Å —Å–∞–º–æ–ª–µ—Ç–∞–º–∏', mgrA: 50, mgrC: 50, netA: 40, netC: 40, cat: '–ü–ª—è–∂–∏', only8h: false },
      { id: 16, name: '–ì–æ—Ä—è—á–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ù–∞—Ç–∞–π', mgrA: 500, mgrC: 300, netA: 400, netC: 200, cat: '–°–ø–∞', only8h: true },
      { id: 17, name: '–ö—É–ø–∞–Ω–∏–µ —Å–æ —Å–ª–æ–Ω–∞–º–∏ –≤ –º–æ—Ä–µ + –ø—Ä–æ–≥—É–ª–∫–∞', mgrA: 1000, mgrC: 1000, netA: 500, netC: 500, cat: '–ñ–∏–≤–æ—Ç–Ω—ã–µ', only8h: false },
      { id: 18, name: '–ö—É–ø–∞–Ω–∏–µ —Å–æ —Å–ª–æ–Ω–∞–º–∏ –≤ –±–∞—Å—Å–µ–π–Ω–µ + –¥—É—à', mgrA: 1000, mgrC: 1000, netA: 500, netC: 500, cat: '–ñ–∏–≤–æ—Ç–Ω—ã–µ', only8h: false },
      { id: 19, name: '–ö—É–ø–∞–Ω–∏–µ —Å–æ —Å–ª–æ–Ω–∞–º–∏ (–ø–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç)', mgrA: 1900, mgrC: 1900, netA: 1000, netC: 1000, cat: '–ñ–∏–≤–æ—Ç–Ω—ã–µ', only8h: false },
      { id: 20, name: '–ö–∞—Ç–∞–Ω–∏–µ –Ω–∞ –∫–≤–∞–¥—Ä–æ—Ü–∏–∫–ª–∞—Ö', mgrA: 1000, mgrC: 700, netA: 500, netC: 500, cat: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', only8h: true },
      { id: 21, name: '–°–ø–ª–∞–≤ –Ω–∞ –±–∞–º–±—É–∫–æ–≤—ã—Ö –ø–ª–æ—Ç–∞—Ö', mgrA: 500, mgrC: 400, netA: 150, netC: 150, cat: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', only8h: true },
    ];

    const CAT_ICONS = { '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏': 'üèõÔ∏è', '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏': 'üèÑ', '–•—Ä–∞–º—ã': '‚õ©Ô∏è', '–ö—É–ª—å—Ç—É—Ä–Ω—ã–µ': 'üé≠', '–ñ–∏–≤–æ—Ç–Ω—ã–µ': 'üêò', '–°–ø–∞': 'üíÜ', '–ü–∏—Ç–∞–Ω–∏–µ': 'üçú', '–ü—Ä–∏—Ä–æ–¥–∞': 'üåø', '–ü–ª—è–∂–∏': 'üèñÔ∏è' };
    const CAT_COLORS = { '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏': '#DBEAFE:#1D4ED8', '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏': '#D1FAE5:#065F46', '–•—Ä–∞–º—ã': '#FEF3C7:#92400E', '–ö—É–ª—å—Ç—É—Ä–Ω—ã–µ': '#EDE9FE:#5B21B6', '–ñ–∏–≤–æ—Ç–Ω—ã–µ': '#FCE7F3:#9D174D', '–°–ø–∞': '#FDF2F8:#831843', '–ü–∏—Ç–∞–Ω–∏–µ': '#FEF9C3:#713F12', '–ü—Ä–∏—Ä–æ–¥–∞': '#DCFCE7:#14532D', '–ü–ª—è–∂–∏': '#E0F2FE:#0C4A6E' };

    // ============================================================
    // STATE
    // ============================================================
    let S = {
      role: null,
      packages: JSON.parse(JSON.stringify(PACKAGES)),
      options: JSON.parse(JSON.stringify(DEF_OPTIONS)),
      selBase: null,
      vip: false,
      qty: {},
      optMk: {},
      cat: 'all',
      nextOptId: 100,
    };

    // ============================================================
    // LOCALSTORAGE
    // ============================================================
    function loadSt() {
      try {
        const d = JSON.parse(localStorage.getItem('png4') || '{}');
        if (d.packages) S.packages = d.packages;
        if (d.options) S.options = d.options;
        if (d.nextOptId) S.nextOptId = d.nextOptId;
      } catch (e) { }
    }

    function saveSt() {
      localStorage.setItem('png4', JSON.stringify({ packages: S.packages, options: S.options, nextOptId: S.nextOptId }));
    }

    // ============================================================
    // ROLE APPLICATION
    // ============================================================
    function roleName(r) { return { manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä', booking: '–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –æ—Ç–¥–µ–ª' }[r] || ''; }

    function applyRole() {
      const bd = document.getElementById('roleDisp');
      const isBkRole = S.role === 'booking';
      const isMgrRole = S.role === 'manager';

      if (!S.role) {
        bd.style.display = 'none';
      } else {
        bd.style.display = 'inline-flex';
        const cls = { manager: 'role-m', booking: 'role-b' }[S.role] || 'role-m';
        const ic = { manager: 'üë§', booking: 'üìã' }[S.role] || 'üë§';
        bd.className = 'role-badge ' + cls;
        bd.textContent = ic + ' ' + roleName(S.role);
      }

      document.getElementById('pkgMkSec').style.display = isBkRole ? 'block' : 'none';
      document.getElementById('addOptBtn').style.display = isBkRole ? 'block' : 'none';
      document.getElementById('optSubtitle').innerHTML = isBkRole
        ? '–ù–µ—Ç—Ç–æ-—Ü–µ–Ω—ã. <span style="color:#92400E;font-weight:600">–ñ—ë–ª—Ç—ã–µ = –Ω–∞—Ü–µ–Ω–∫–∞</span>'
        : '–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ –¥–µ—Ç–µ–π';
    }

    // ============================================================
    // HELPERS
    // ============================================================
    function isBk() { return S.role === 'booking'; }
    function getHours() { const b = S.packages.find(p => p.id === S.selBase); return b ? b.hours : 8; }
    function availOpts() {
      const is5 = S.selBase === 'base5';
      return S.options.filter(o => !is5 || !o.only8h);
    }

    // ============================================================
    // RENDER ALL
    // ============================================================
    function renderAll() { renderBase(); renderVip(); renderCats(); renderOpts(); recalc(); applyRole(); }

    function renderBase() {
      const bk = isBk();
      const bases = S.packages.filter(p => p.type === 'base');
      document.getElementById('baseGrid').innerHTML = bases.map(p => {
        const price = bk ? p.nettoPrice : p.mgrPrice;
        return `<div class="pkg-card ${S.selBase === p.id ? 'sel' : ''}" onclick="selBase('${p.id}')">
      <div class="pkg-icon">${p.hours === 8 ? 'üïó' : 'üïê'}</div>
      <div class="pkg-name">${p.hours} —á–∞—Å–æ–≤</div>
      <div class="pkg-note">${esc(p.note)}<br>–î–æ–ø. —á–∞—Å: ${fmt(p.extraHour)} ‡∏ø</div>
      <div class="pkg-price">${fmt(price)} <span>‡∏ø</span></div>
      ${bk ? `<div class="pkg-netto">–ù–ï–¢–¢–û: ${esc(p.nettoDetail)}</div>` : ''}
    </div>`;
      }).join('');
    }

    function selBase(id) {
      S.selBase = S.selBase === id ? null : id;
      if (S.selBase) {
        const av = availOpts(); const ids = new Set(av.map(o => o.id));
        Object.keys(S.qty).forEach(k => { if (!ids.has(+k)) delete S.qty[k]; });
      }
      renderBase(); renderVip(); renderOpts(); recalc();
    }

    function renderVip() {
      if (!S.selBase) {
        document.getElementById('vipBox').innerHTML = '<div style="font-size:11px;color:var(--text-light)">‚Üê –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑–æ–≤—ã–π –ø–∞–∫–µ—Ç</div>';
        S.vip = false; renderNetto(); return;
      }
      const bk = isBk(); const h = getHours();
      const vp = S.packages.find(p => p.type === 'vip' && p.hours === h);
      if (!vp) { document.getElementById('vipBox').innerHTML = ''; return; }
      const baseP = S.packages.find(p => p.id === S.selBase);
      const vipFull = bk ? vp.nettoPrice : vp.mgrPrice;
      const baseFull = bk ? baseP.nettoPrice : baseP.mgrPrice;
      const delta = vipFull - baseFull;

      document.getElementById('vipBox').innerHTML = `
    <div class="vip-box ${S.vip ? 'sel' : ''}" onclick="togVip()">
      <div class="vip-chk">${S.vip ? '‚úì' : ''}</div>
      <div class="vip-info">
        <div class="vip-name">‚≠ê ${esc(vp.name)}</div>
        <div class="vip-note">${esc(vp.note)} ¬∑ –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ –ø–∞–∫–µ—Ç–∞</div>
        ${bk ? `<div class="vip-netto">–ù–ï–¢–¢–û: ${esc(vp.nettoDetail)}</div>` : ''}
      </div>
      <div>
        <div class="vip-price">${fmt(vipFull)} ‡∏ø</div>
        <div style="font-size:10px;color:var(--text-light);text-align:right">${delta >= 0 ? '+' : ''}${fmt(delta)} ‡∏ø –∫ –±–∞–∑–µ</div>
      </div>
    </div>`;
      renderNetto();
    }

    function renderNetto() {
      const el = document.getElementById('nettoInfo');
      if (!isBk() || !S.selBase) { el.style.display = 'none'; return; }
      const base = S.packages.find(p => p.id === S.selBase);
      const h = getHours();
      const vp = S.vip ? S.packages.find(p => p.type === 'vip' && p.hours === h) : null;
      const act = vp || base;
      el.style.display = 'block';
      el.innerHTML = `
    <b>üìä –ù–µ—Ç—Ç–æ-—Ä–∞—Å–∫–ª–∞–¥ –ø–∞–∫–µ—Ç–∞:</b><br>
    ${esc(act.nettoDetail)} = <b>${fmt(act.nettoPrice)} ‡∏ø</b><br>
    –ü—Ä–æ–¥–∞–∂–Ω–∞—è —Ü–µ–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞: <b>${fmt(act.mgrPrice)} ‡∏ø</b><br>
    –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –º–∞—Ä–∂–∞: <b>${fmt(act.mgrPrice - act.nettoPrice)} ‡∏ø</b>
  `;
    }

    function togVip() {
      if (!S.selBase) { toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç', 'err'); return; }
      S.vip = !S.vip; renderVip(); recalc();
    }

    // ============================================================
    // CATEGORIES
    // ============================================================
    function renderCats() {
      const cats = ['all', ...new Set(S.options.map(o => o.cat))];
      document.getElementById('catFilters').innerHTML = cats.map(c =>
        `<button class="cat-btn ${S.cat === c ? 'on' : ''}" onclick="setCat('${c}')">${c === 'all' ? 'üåê –í—Å–µ' : (CAT_ICONS[c] || '') + ' ' + c}</button>`
      ).join('');
    }

    function setCat(c) { S.cat = c; renderCats(); renderOpts(); }

    // ============================================================
    // OPTIONS TABLE
    // ============================================================
    function renderOpts() {
      const bk = isBk();
      const av = availOpts();
      const filtered = S.cat === 'all' ? av : av.filter(o => o.cat === S.cat);
      const is5 = S.selBase === 'base5';
      document.getElementById('optNotice').style.display = is5 ? 'block' : 'none';

      let th = '<th style="text-align:left">–û–ø—Ü–∏—è</th><th>–í–∑—Ä.</th><th>–î–µ—Ç.</th>';
      if (bk) {
        th += '<th>–ù–µ—Ç—Ç–æ –≤–∑—Ä.</th><th class="mk">+–ù–∞—Ü.</th><th>–ù–µ—Ç—Ç–æ –¥–µ—Ç.</th><th class="mk">+–ù–∞—Ü.</th><th>–°–µ–±–µ—Å—Ç.</th><th class="fn">–ö–ª–∏–µ–Ω—Ç</th>';
      } else {
        th += '<th>–¶–µ–Ω–∞ –≤–∑—Ä.</th><th>–¶–µ–Ω–∞ –¥–µ—Ç.</th><th>–°—É–º–º–∞</th>';
      }
      document.getElementById('optHead').innerHTML = th;

      document.getElementById('optBody').innerHTML = filtered.map(o => {
        const q = S.qty[o.id] || { a: 0, c: 0 };
        const mk = S.optMk[o.id] || { a: 0, c: 0 };
        const has = (q.a || 0) + (q.c || 0) > 0;
        const [bg, fg] = (CAT_COLORS[o.cat] || '#F1F5F9:#64748B').split(':');

        let cells = `<td><div class="oname">${esc(o.name)}</div><span class="ocat" style="background:${bg};color:${fg}">${CAT_ICONS[o.cat] || ''} ${o.cat}</span>${o.special ? `<div style="font-size:9px;color:var(--warning);margin-top:1px">‚ö†Ô∏è ${esc(o.special)}</div>` : ''}</td>`;
        cells += `<td><input class="qi" type="number" min="0" max="99" value="${q.a || ''}" placeholder="0" oninput="setQ(${o.id},'a',this.value)"></td>`;
        cells += `<td><input class="qi" type="number" min="0" max="99" value="${q.c || ''}" placeholder="0" oninput="setQ(${o.id},'c',this.value)"></td>`;

        if (bk) {
          const costSum = (q.a || 0) * o.netA + (q.c || 0) * o.netC;
          const clientSum = (q.a || 0) * (o.netA + (mk.a || 0)) + (q.c || 0) * (o.netC + (mk.c || 0));
          cells += `<td class="pc ${o.netA === 0 ? 'fr' : ''}">${o.netA > 0 ? fmt(o.netA) : 'FREE'}</td>`;
          cells += `<td style="background:#FFFBEB"><input class="mi" type="number" min="0" value="${mk.a || ''}" placeholder="0" oninput="setMk(${o.id},'a',this.value)"></td>`;
          cells += `<td class="pc ${o.netC === 0 ? 'fr' : ''}">${o.netC > 0 ? fmt(o.netC) : 'FREE'}</td>`;
          cells += `<td style="background:#FFFBEB"><input class="mi" type="number" min="0" value="${mk.c || ''}" placeholder="0" oninput="setMk(${o.id},'c',this.value)"></td>`;
          cells += `<td class="sc ${costSum === 0 ? 'z' : ''}">${costSum > 0 ? fmt(costSum) : '‚Äî'}</td>`;
          cells += `<td class="fc" style="background:#F0FDF4">${clientSum > 0 ? fmt(clientSum) : '‚Äî'}</td>`;
        } else {
          const prA = o.mgrA, prC = o.mgrC;
          const sum = (q.a || 0) * prA + (q.c || 0) * prC;
          cells += `<td class="pc ${prA === 0 ? (o.special ? 'sp' : 'fr') : ''}">${o.special ? '‚ö†Ô∏è' : prA > 0 ? fmt(prA) + ' ‡∏ø' : 'FREE'}</td>`;
          cells += `<td class="pc ${prC === 0 ? (o.special ? 'sp' : 'fr') : ''}">${o.special ? '' : prC > 0 ? fmt(prC) + ' ‡∏ø' : 'FREE'}</td>`;
          cells += `<td class="sc ${sum === 0 ? 'z' : ''}">${sum > 0 ? fmt(sum) + ' ‡∏ø' : '‚Äî'}</td>`;
        }
        return `<tr class="orow ${has ? 'has' : ''}">${cells}</tr>`;
      }).join('');
    }

    function setQ(id, t, v) { if (!S.qty[id]) S.qty[id] = { a: 0, c: 0 }; S.qty[id][t] = Math.max(0, parseInt(v) || 0); renderOpts(); recalc(); }
    function setMk(id, t, v) { if (!S.optMk[id]) S.optMk[id] = { a: 0, c: 0 }; S.optMk[id][t] = Math.max(0, parseInt(v) || 0); renderOpts(); recalc(); }

    // ============================================================
    // RECALC
    // ============================================================
    function recalc() {
      const bk = isBk();
      const basePkg = S.packages.find(p => p.id === S.selBase);
      const h = getHours();
      const vipPkg = S.vip ? S.packages.find(p => p.type === 'vip' && p.hours === h) : null;
      const act = vipPkg || basePkg;

      const pkgNet = act ? act.nettoPrice : 0;
      const pkgMgr = act ? act.mgrPrice : 0;
      const pmB = bk ? (parseInt(document.getElementById('pkgMkB')?.value) || 0) : 0;
      const pmP = bk ? (parseInt(document.getElementById('pkgMkP')?.value) || 0) : 0;
      const pkgMkCalc = Math.round(pkgNet * pmP / 100) + pmB;

      let optNet = 0, optMkT = 0, optMgrT = 0;
      const selOpts = [];
      const avIds = new Set(availOpts().map(o => o.id));

      S.options.forEach(o => {
        if (!avIds.has(o.id)) return;
        const q = S.qty[o.id] || { a: 0, c: 0 };
        if ((q.a || 0) + (q.c || 0) === 0) return;
        const mk = S.optMk[o.id] || { a: 0, c: 0 };
        const net = (q.a || 0) * o.netA + (q.c || 0) * o.netC;
        const markup = (q.a || 0) * (mk.a || 0) + (q.c || 0) * (mk.c || 0);
        const mgr = (q.a || 0) * o.mgrA + (q.c || 0) * o.mgrC;
        optNet += net; optMkT += markup; optMgrT += mgr;
        selOpts.push({ ...o, q, mk, net, markup, client: net + markup, mgr });
      });

      let totalClient;
      if (bk) { totalClient = pkgNet + pkgMkCalc + optNet + optMkT; }
      else { totalClient = pkgMgr + optMgrT; }

      let sl = '';
      if (bk) {
        sl += sLine('üöê –ü–∞–∫–µ—Ç –Ω–µ—Ç—Ç–æ', fmt(pkgNet) + ' ‡∏ø');
        if (pkgMkCalc > 0) sl += sLine('üí∞ –ù–∞—Ü–µ–Ω–∫–∞ –ø–∞–∫–µ—Ç', '+' + fmt(pkgMkCalc) + ' ‡∏ø', '#92400E');
        sl += sLine('üéØ –û–ø—Ü–∏–∏ –Ω–µ—Ç—Ç–æ', fmt(optNet) + ' ‡∏ø');
        if (optMkT > 0) sl += sLine('üí∞ –ù–∞—Ü–µ–Ω–∫–∞ –æ–ø—Ü–∏–∏', '+' + fmt(optMkT) + ' ‡∏ø', '#92400E');
        sl += '<div style="height:1px;background:var(--border);margin:6px 0"></div>';
        sl += sLine('üì¶ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å', fmt(pkgNet + optNet) + ' ‡∏ø');
        sl += sLine('üí∞ –û–±—â–∞—è –Ω–∞—Ü–µ–Ω–∫–∞', '+' + fmt(pkgMkCalc + optMkT) + ' ‡∏ø', '#92400E');
        sl += sLine('üìä –ú–∞—Ä–∂–∞ –ø–∞–∫–µ—Ç–∞ (–≤—Å—Ç—Ä.)', fmt(pkgMgr - pkgNet) + ' ‡∏ø', 'var(--success)');
      } else {
        if (act) sl += sLine('üöê –ü–∞–∫–µ—Ç', fmt(pkgMgr) + ' ‡∏ø');
        if (optMgrT > 0) sl += sLine('üéØ –û–ø—Ü–∏–∏', fmt(optMgrT) + ' ‡∏ø');
      }
      document.getElementById('sumLines').innerHTML = sl;
      document.getElementById('sumTotal').textContent = fmt(totalClient) + ' ‡∏ø';

      let ll = '';
      if (act) {
        const p = bk ? (pkgNet + pkgMkCalc) : pkgMgr;
        ll += `<div class="sopt"><div><div class="sopt-n">${S.vip ? '‚≠ê' : 'üöê'} ${esc(act.name)}</div><div class="sopt-d">${esc(act.note)}</div></div><div class="sopt-p">${fmt(p)} ‡∏ø</div></div>`;
      }
      selOpts.forEach(o => {
        const det = [o.q.a > 0 ? o.q.a + ' –≤–∑—Ä.' : '', o.q.c > 0 ? o.q.c + ' –¥–µ—Ç.' : ''].filter(Boolean).join(', ');
        const p = bk ? o.client : o.mgr;
        ll += `<div class="sopt"><div><div class="sopt-n">${CAT_ICONS[o.cat] || '‚Ä¢'} ${esc(o.name)}</div><div class="sopt-d">${det}</div></div><div class="sopt-p">${fmt(p)} ‡∏ø</div></div>`;
      });
      document.getElementById('selList').innerHTML = ll || '<div class="empty"><div class="ei">üéØ</div><p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç</p></div>';

      S._calc = { act, pkgNet, pkgMgr, pkgMkCalc, selOpts, optNet, optMkT, optMgrT, totalClient };
    }

    function sLine(l, v, c) { return `<div class="sline"><span class="sl">${l}</span><span class="sv" style="${c ? 'color:' + c : ''}">${v}</span></div>`; }

    // ============================================================
    // ADD / DELETE OPTIONS
    // ============================================================
    function openAddOpt() { document.getElementById('addOptModal').classList.add('open'); }

    function addNewOpt() {
      const name = document.getElementById('newOptName').value.trim();
      if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'err'); return; }
      S.options.push({
        id: S.nextOptId++,
        name,
        mgrA: parseInt(document.getElementById('newOptMgrA').value) || 0,
        mgrC: parseInt(document.getElementById('newOptMgrC').value) || 0,
        netA: parseInt(document.getElementById('newOptNetA').value) || 0,
        netC: parseInt(document.getElementById('newOptNetC').value) || 0,
        cat: document.getElementById('newOptCat').value,
        only8h: document.getElementById('newOptOnly8').checked,
      });
      saveSt();
      closeModal('addOptModal');
      document.getElementById('newOptName').value = '';
      renderAll();
      toast('–û–ø—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞: ' + name, 'ok');
    }

    function addOptFromAdmin() {
      const name = document.getElementById('admNewName').value.trim();
      if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'err'); return; }
      S.options.push({
        id: S.nextOptId++,
        name,
        mgrA: parseInt(document.getElementById('admNewMgrA').value) || 0,
        mgrC: parseInt(document.getElementById('admNewMgrC').value) || 0,
        netA: parseInt(document.getElementById('admNewNetA').value) || 0,
        netC: parseInt(document.getElementById('admNewNetC').value) || 0,
        cat: document.getElementById('admNewCat').value,
        only8h: document.getElementById('admNewOnly8').checked,
      });
      saveSt();
      document.getElementById('admNewName').value = '';
      renderAdmin(); renderAll();
      toast('–û–ø—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞: ' + name, 'ok');
    }

    function deleteOpt(id) {
      const opt = S.options.find(o => o.id === id);
      if (!opt) return;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø—Ü–∏—é "' + opt.name + '"?')) return;
      S.options = S.options.filter(o => o.id !== id);
      delete S.qty[id]; delete S.optMk[id];
      saveSt(); renderAdmin(); renderAll();
      toast('–£–¥–∞–ª–µ–Ω–æ: ' + opt.name, 'ok');
    }

    // ============================================================
    // COLLECT CLIENT DATA
    // ============================================================
    function clientData() {
      const c = S._calc;
      if (!c || !c.act) return null;
      const bk = isBk();
      const items = [];
      const pkgP = bk ? (c.pkgNet + c.pkgMkCalc) : c.pkgMgr;
      items.push({ name: c.act.name, note: c.act.note, price: pkgP, type: c.act.type === 'vip' ? 'vip' : 'package' });
      (c.selOpts || []).forEach(o => {
        const aP = bk ? (o.netA + (o.mk?.a || 0)) : o.mgrA;
        const cP = bk ? (o.netC + (o.mk?.c || 0)) : o.mgrC;
        items.push({ name: o.name, cat: o.cat, aQ: o.q.a || 0, cQ: o.q.c || 0, aP, cP, sum: bk ? o.client : o.mgr, type: 'opt' });
      });
      return {
        name: document.getElementById('cName').value,
        date: document.getElementById('cDate').value,
        phone: document.getElementById('cPhone').value,
        note: document.getElementById('cNote').value,
        items, total: c.totalClient,
        gen: new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' })
      };
    }

    // ============================================================
    // PRINT
    // ============================================================
    function doPrint() {
      const d = clientData();
      if (!d) { toast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç', 'err'); return; }
      const pkgs = d.items.filter(i => i.type !== 'opt'), opts = d.items.filter(i => i.type === 'opt');
      const optR = opts.map(o => `<tr><td>${esc(o.name)}</td><td style="text-align:center">${o.aQ}</td><td style="text-align:center">${o.cQ}</td><td style="text-align:right">${fmt(o.aP)} ‡∏ø</td><td style="text-align:right">${fmt(o.cP)} ‡∏ø</td><td style="text-align:right;font-weight:700">${fmt(o.sum)} ‡∏ø</td></tr>`).join('');

      document.getElementById('printArea').innerHTML = `<div class="pp">
    <div class="ph"><div><div class="pc-name">üå¥ –ü—Ö–∞–Ω–≥ –ù–≥–∞ –¢—É—Ä—ã</div><div class="pc-sub">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—É—Ä—ã ¬∑ –¢–∞–π–ª–∞–Ω–¥</div></div><div style="text-align:right"><div style="font-size:16px;font-weight:700">–†–∞—Å—á—ë—Ç —Ç—É—Ä–∞</div><div style="font-size:10px;color:#64748B">${d.gen}</div></div></div>
    <div class="pi">${d.name ? `<div><div class="pi-l">–ö–ª–∏–µ–Ω—Ç</div><div class="pi-v">${esc(d.name)}</div></div>` : ''}${d.date ? `<div><div class="pi-l">–î–∞—Ç–∞</div><div class="pi-v">${fmtDate(d.date)}</div></div>` : ''}${d.phone ? `<div><div class="pi-l">–¢–µ–ª–µ—Ñ–æ–Ω</div><div class="pi-v">${esc(d.phone)}</div></div>` : ''}${d.note ? `<div style="grid-column:1/-1"><div class="pi-l">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div><div class="pi-v" style="font-weight:400;font-size:11px">${esc(d.note)}</div></div>` : ''}</div>
    ${pkgs.map(p => `<div style="background:#0F4C75;color:#fff;border-radius:8px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><div style="font-size:9px;opacity:.8;text-transform:uppercase;margin-bottom:2px">${p.type === 'vip' ? '‚≠ê VIP' : 'üöê –ü–ê–ö–ï–¢'}</div><div style="font-weight:700;font-size:13px">${esc(p.name)}</div><div style="font-size:10px;opacity:.8">${esc(p.note || '')}</div></div><div style="font-size:18px;font-weight:800">${fmt(p.price)} ‡∏ø</div></div>`).join('')}
    ${opts.length ? `<div style="font-size:12px;font-weight:700;margin:12px 0 6px">üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏</div><table><thead><tr><th style="text-align:left">–û–ø—Ü–∏—è</th><th>–í–∑—Ä.</th><th>–î–µ—Ç.</th><th style="text-align:right">–¶–µ–Ω–∞ –≤–∑—Ä.</th><th style="text-align:right">–¶–µ–Ω–∞ –¥–µ—Ç.</th><th style="text-align:right">–°—É–º–º–∞</th></tr></thead><tbody>${optR}</tbody></table>` : ''}
    <div class="pt"><div><div style="font-size:12px;font-weight:600;opacity:.9">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</div><div style="font-size:10px;opacity:.7">—Ç–∞–π—Å–∫–∏—Ö –±–∞—Ç (THB)</div></div><div style="font-size:26px;font-weight:800">${fmt(d.total)} ‡∏ø</div></div>
    <div style="margin-top:14px;text-align:center;font-size:9px;color:#94A3B8">–ü—Ö–∞–Ω–≥ –ù–≥–∞ –¢—É—Ä—ã ¬∑ –¢–∞–π–ª–∞–Ω–¥</div>
  </div>`;
      window.print();
    }

    // ============================================================
    // TEXT
    // ============================================================
    function showText() {
      const d = clientData();
      if (!d) { toast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç', 'err'); return; }
      const L = ['üå¥ *–†–ê–°–ß–Å–¢ –¢–£–†–ê ‚Äî –ü–•–ê–ù–ì –ù–ì–ê*', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ'];
      if (d.name) L.push('üë§ –ö–ª–∏–µ–Ω—Ç: ' + d.name);
      if (d.date) L.push('üìÖ –î–∞—Ç–∞: ' + fmtDate(d.date));
      if (d.phone) L.push('üì± –¢–µ–ª: ' + d.phone);
      L.push('');
      const pkgs = d.items.filter(i => i.type !== 'opt'), opts = d.items.filter(i => i.type === 'opt');
      if (pkgs.length) { L.push('üöê *–ü–ê–ö–ï–¢*'); pkgs.forEach(p => L.push('‚Ä¢ ' + p.name + ' ‚Äî ' + fmt(p.price) + ' ‡∏ø')); L.push(''); }
      if (opts.length) { L.push('üéØ *–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û*'); opts.forEach(o => { const det = [o.aQ > 0 ? o.aQ + ' –≤–∑—Ä.' : '', o.cQ > 0 ? o.cQ + ' –¥–µ—Ç.' : ''].filter(Boolean).join(', '); L.push('‚Ä¢ ' + o.name + ' (' + det + ') ‚Äî ' + fmt(o.sum) + ' ‡∏ø'); }); L.push(''); }
      L.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      L.push('üí≥ *–ò–¢–û–ì–û: ' + fmt(d.total) + ' ‡∏ø*');
      L.push(''); L.push('_–ü—Ö–∞–Ω–≥ –ù–≥–∞ –¢—É—Ä—ã ¬∑ –¢–∞–π–ª–∞–Ω–¥_');
      if (d.note) { L.push(''); L.push('üìù ' + d.note); }
      document.getElementById('textOut').textContent = L.join('\n');
      document.getElementById('textModal').classList.add('open');
    }

    function copyText() { clipCopy(document.getElementById('textOut').textContent, '–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'); }

    // ============================================================
    // LINK ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: genLink() + saveCalculation –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
    // ============================================================
    async function genLink() {
      const d = clientData();
      if (!d) { toast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç', 'err'); return; }

      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º UUID-—Å—Å—ã–ª–∫—É
      if (currentUser) {
        const calcId = await saveCalculation(
          d.name || '',
          d.date || null,
          d
        );
        if (!calcId) return;
        const url = location.origin + location.pathname + '?tour=' + calcId;
        document.getElementById('shareUrl').value = url;
        document.getElementById('linkModal').classList.add('open');
        try { await navigator.clipboard.writeText(url); toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'ok'); } catch (e) { }
      } else {
        // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: base64 –≤ URL (–±–µ–∑ –ë–î)
        const encoded = btoa(encodeURIComponent(JSON.stringify(d)));
        const url = location.origin + location.pathname + '?tour=' + encoded;
        document.getElementById('shareUrl').value = url;
        document.getElementById('linkModal').classList.add('open');
        try { await navigator.clipboard.writeText(url); toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'ok'); } catch (e) { }
      }
    }

    function copyLink() { clipCopy(document.getElementById('shareUrl').value, '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'); }

    // ============================================================
    // CLIENT PAGE
    // ============================================================
    function renderClientPage(d) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-client').classList.add('active');
      const nav = document.getElementById('headerNav');
      if (nav) nav.innerHTML = '<span style="font-size:11px;opacity:.8">üìÑ –†–∞—Å—á—ë—Ç —Ç—É—Ä–∞</span>';
      const pkgs = (d.items || []).filter(i => i.type !== 'opt'), opts = (d.items || []).filter(i => i.type === 'opt');
      let h = `<div class="cp-hero"><div style="font-size:36px">üå¥</div><h1>–í–∞—à —Ç—É—Ä –≤ –ü—Ö–∞–Ω–≥ –ù–≥–∞</h1><p>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç${d.name ? ' –¥–ª—è ' + esc(d.name) : ''}</p></div>`;
      if (d.name || d.date) {
        h += '<div class="card"><div class="card-b" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
        if (d.name) h += `<div><div style="font-size:9px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin-bottom:2px">–ö–ª–∏–µ–Ω—Ç</div><div style="font-weight:700">${esc(d.name)}</div></div>`;
        if (d.date) h += `<div><div style="font-size:9px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin-bottom:2px">–î–∞—Ç–∞</div><div style="font-weight:700">${fmtDate(d.date)}</div></div>`;
        if (d.phone) h += `<div><div style="font-size:9px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin-bottom:2px">–¢–µ–ª–µ—Ñ–æ–Ω</div><div style="font-weight:700">${esc(d.phone)}</div></div>`;
        h += '</div></div>';
      }
      pkgs.forEach(p => { h += `<div class="card"><div class="card-b" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:9px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin-bottom:3px">${p.type === 'vip' ? '‚≠ê VIP' : 'üöê –ü–∞–∫–µ—Ç'}</div><div style="font-weight:700;font-size:14px">${esc(p.name)}</div><div style="font-size:10px;color:var(--text-light);margin-top:1px">${esc(p.note || '')}</div></div><div style="font-size:18px;font-weight:800;color:var(--primary)">${fmt(p.price)} ‡∏ø</div></div></div>`; });
      if (opts.length) {
        h += '<div class="card"><div class="card-b"><div style="font-size:9px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin-bottom:8px">üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏</div>';
        opts.forEach(o => { const det = [o.aQ > 0 ? o.aQ + ' –≤–∑—Ä.' : '', o.cQ > 0 ? o.cQ + ' –¥–µ—Ç.' : ''].filter(Boolean).join(', '); h += `<div class="sopt"><div><div class="sopt-n">${esc(o.name)}</div><div class="sopt-d">${det}</div></div><div class="sopt-p">${fmt(o.sum)} ‡∏ø</div></div>`; });
        h += '</div></div>';
      }
      h += `<div class="ct-box"><div class="ctl">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</div><div class="cta">${fmt(d.total)} ‡∏ø</div><div class="ctc">—Ç–∞–π—Å–∫–∏—Ö –±–∞—Ç (THB)</div></div>`;
      if (d.note) h += `<div class="card"><div class="card-b"><div style="font-size:9px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin-bottom:3px">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div><div style="font-size:12px">${esc(d.note)}</div></div></div>`;
      h += `<div style="text-align:center;font-size:10px;color:var(--text-light);margin-top:16px;padding-bottom:24px">${d.gen ? '–†–∞—Å—á—ë—Ç –æ—Ç ' + d.gen + ' ¬∑ ' : ''}–ü—Ö–∞–Ω–≥ –ù–≥–∞ –¢—É—Ä—ã</div>`;
      document.getElementById('clientPage').innerHTML = h;
    }

    // ============================================================
    // ADMIN (inside booking page)
    // ============================================================
    function renderAdmin() {
      // Packages table
      document.getElementById('aPkgTbl').innerHTML = S.packages.map((p, i) => `<tr>
    <td style="width:50px;text-align:center;color:var(--text-light);font-weight:600;font-size:9px">${p.id}</td>
    <td style="width:45px"><input value="${eA(p.type)}" oninput="S.packages[${i}].type=this.value" style="text-align:center"></td>
    <td style="width:35px"><input type="number" value="${p.hours}" oninput="S.packages[${i}].hours=parseInt(this.value)||0"></td>
    <td><input type="text" value="${eA(p.name)}" oninput="S.packages[${i}].name=this.value"></td>
    <td style="width:85px"><input type="number" value="${p.mgrPrice}" oninput="S.packages[${i}].mgrPrice=parseInt(this.value)||0"></td>
    <td style="width:85px"><input type="number" value="${p.nettoPrice}" oninput="S.packages[${i}].nettoPrice=parseInt(this.value)||0"></td>
    <td><input type="text" value="${eA(p.note)}" oninput="S.packages[${i}].note=this.value"></td>
    <td><input type="text" value="${eA(p.nettoDetail || '')}" oninput="S.packages[${i}].nettoDetail=this.value"></td>
  </tr>`).join('');

      // Options table
      document.getElementById('aOptTbl').innerHTML = S.options.map((o, i) => `<tr>
    <td style="width:28px;text-align:center;color:var(--text-light);font-weight:600;font-size:9px">${o.id}</td>
    <td><input type="text" value="${eA(o.name)}" oninput="S.options[${i}].name=this.value"></td>
    <td style="width:65px"><input type="number" value="${o.mgrA}" oninput="S.options[${i}].mgrA=parseInt(this.value)||0"></td>
    <td style="width:65px"><input type="number" value="${o.mgrC}" oninput="S.options[${i}].mgrC=parseInt(this.value)||0"></td>
    <td style="width:65px"><input type="number" value="${o.netA}" oninput="S.options[${i}].netA=parseInt(this.value)||0"></td>
    <td style="width:65px"><input type="number" value="${o.netC}" oninput="S.options[${i}].netC=parseInt(this.value)||0"></td>
    <td style="width:110px"><input type="text" value="${eA(o.cat)}" oninput="S.options[${i}].cat=this.value"></td>
    <td style="width:45px;text-align:center"><input type="checkbox" ${o.only8h ? 'checked' : ''} onchange="S.options[${i}].only8h=this.checked" style="width:auto"></td>
  </tr>`).join('');

      // Delete list
      document.getElementById('deleteOptsList').innerHTML = S.options.map(o => `
    <div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--border)">
      <button class="btn-del" onclick="deleteOpt(${o.id})">‚úï</button>
      <div style="flex:1;font-size:12px;font-weight:500">${esc(o.name)}</div>
      <div style="font-size:10px;color:var(--text-light)">${o.cat} ${o.only8h ? '¬∑ —Ç–æ–ª—å–∫–æ 8—á' : ''}</div>
      <div style="font-size:11px;font-weight:600;color:var(--primary)">${fmt(o.mgrA)}/${fmt(o.mgrC)} ‡∏ø</div>
    </div>
  `).join('');
    }

    function saveAdmin() { saveSt(); renderAll(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'ok'); }

    function bkTab(n) {
      const tabs = ['calc', 'pkgs', 'opts', 'addrem'];
      document.querySelectorAll('.bk-tab').forEach((t, i) => t.classList.toggle('on', tabs[i] === n));
      document.querySelectorAll('.bk-tab-content').forEach(c => c.classList.remove('on'));
      document.getElementById('bkt-' + n)?.classList.add('on');
      if (n === 'addrem') renderAdmin();
    }

    // ============================================================
    // UTILS
    // ============================================================
    function fmt(n) { return (n || 0).toLocaleString('ru-RU'); }
    function fmtDate(d) {
      if (!d) return '';
      const p = d.split('-');
      if (p.length !== 3) return d;
      const [y, m, day] = p;
      const ms = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
      const mi = parseInt(m) - 1;
      return mi >= 0 && mi < 12 ? parseInt(day) + ' ' + ms[mi] + ' ' + y : d;
    }
    function esc(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function eA(s) { return String(s || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function clipCopy(t, m) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(t).then(() => toast(m, 'ok')).catch(() => fbCopy(t, m));
      } else {
        fbCopy(t, m);
      }
    }
    function fbCopy(t, m) {
      const a = document.createElement('textarea');
      a.value = t;
      document.body.appendChild(a);
      a.select();
      document.execCommand('copy');
      document.body.removeChild(a);
      toast(m, 'ok');
    }
    function showPage(n) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + n)?.classList.add('active');
    }
    function closeModal(id) { document.getElementById(id)?.classList.remove('open'); }
    function toast(m, t = '') {
      const e = document.getElementById('toast');
      document.getElementById('toastMsg').textContent = m;
      e.className = 'toast show ' + (t || '');
      setTimeout(() => e.className = 'toast', 3000);
    }
    function resetAll() {
      S.selBase = null; S.vip = false; S.qty = {}; S.optMk = {};
      document.getElementById('cName').value = '';
      document.getElementById('cDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('cPhone').value = '';
      document.getElementById('cNote').value = '';
      if (document.getElementById('pkgMkB')) document.getElementById('pkgMkB').value = 0;
      if (document.getElementById('pkgMkP')) document.getElementById('pkgMkP').value = 0;
      renderAll();
      toast('–°–±—Ä–æ—à–µ–Ω–æ');
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    document.querySelectorAll('.mo').forEach(o => {
      o.addEventListener('click', function (e) {
        if (e.target === this) this.classList.remove('open');
      });
    });

  </script>
</body>
</html>
